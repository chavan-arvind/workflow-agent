steps:
# Print the contents of the current directory
- name: 'ubuntu'
  args: ['ls', '-la']

# Print the contents of the src directory
- name: 'ubuntu'
  args: ['ls', '-la', 'src']

# Install dependencies
- name: 'gcr.io/cloud-builders/npm'
  args: ['install']
  dir: 'src'

# Build the Docker image
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/my-function', '.']

# Deploy cloneRepoToStorage function
- name: 'gcr.io/cloud-builders/gcloud'
  args: 
    - 'functions'
    - 'deploy'
    - 'cloneRepoToStorage'
    - '--trigger-http'
    - '--runtime=nodejs16'
    - '--entry-point=cloneRepoToStorage'
    - '--source=src'
    - '--allow-unauthenticated'

# Deploy analyzeCode function
- name: 'gcr.io/cloud-builders/gcloud'
  args:
    - 'functions'
    - 'deploy'
    - 'analyzeCode'
    - '--trigger-http'
    - '--runtime=nodejs16'
    - '--entry-point=analyzeCode'
    - '--source=src'
    - '--allow-unauthenticated'

images:
- 'gcr.io/$PROJECT_ID/my-function'